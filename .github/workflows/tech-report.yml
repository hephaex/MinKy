name: Tech Report Generator

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  generate-report:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Tech Report
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prTitle = pr.title;
            const prBody = pr.body || '';

            // ë‚ ì§œ í¬ë§·
            const date = new Date().toISOString().split('T')[0];

            // ìŠ¬ëŸ¬ê·¸ ìƒì„±
            const slug = prTitle
              .toLowerCase()
              .replace(/[^a-z0-9ê°€-í£]+/g, '-')
              .replace(/^-|-$/g, '')
              .substring(0, 30);

            // ê´€ë ¨ ì´ìŠˆ ì°¾ê¸°
            const closingIssueMatch = prBody.match(/(?:closes?|fixes?|resolves?)\s*#(\d+)/i);
            const relatedIssue = closingIssueMatch ? closingIssueMatch[1] : null;

            // ë³€ê²½ íŒŒì¼ ì •ë³´
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            const changedFiles = files.map(f => `- \`${f.filename}\`: +${f.additions}/-${f.deletions}`).join('\n');

            // íƒœê·¸ ì¶”ì¶œ
            const tags = [];
            if (files.some(f => f.filename.includes('rust') || f.filename.endsWith('.rs'))) tags.push('#rust');
            if (files.some(f => f.filename.includes('frontend') || f.filename.endsWith('.js') || f.filename.endsWith('.tsx'))) tags.push('#frontend');
            if (prTitle.toLowerCase().includes('fix')) tags.push('#bugfix');
            if (prTitle.toLowerCase().includes('feat')) tags.push('#feature');

            // ê¸°ìˆ  ë³´ê³ ì„œ ìƒì„±
            const report = `# ê¸°ìˆ  ë³´ê³ ì„œ: ${prTitle}

**PR**: #${prNumber}
**ì´ìŠˆ**: ${relatedIssue ? `#${relatedIssue}` : 'N/A'}
**ë‚ ì§œ**: ${date}
**ì‘ì„±ì**: Technical Writer Agent (GitHub Actions)

---

## ğŸ“‹ ê°œìš”

### PR ìš”ì•½
${prBody.split('\n').slice(0, 10).join('\n') || 'ì„¤ëª… ì—†ìŒ'}

---

## ğŸ”§ ë³€ê²½ ì‚¬í•­

### ë³€ê²½ëœ íŒŒì¼ (${files.length}ê°œ)
${changedFiles}

### í†µê³„
- **ì¶”ê°€ëœ ë¼ì¸**: +${additions}
- **ì‚­ì œëœ ë¼ì¸**: -${deletions}

---

## ğŸ“š í•™ìŠµ í¬ì¸íŠ¸

### 1. ì´ PRì—ì„œ ë°°ìš¸ ì 
- **ë¬´ì—‡**: ì´ PRì˜ ì£¼ìš” ë³€ê²½ ì‚¬í•­ì„ ë¶„ì„í•˜ì„¸ìš”
- **ì™œ ì¤‘ìš”**: ì½”ë“œ í’ˆì§ˆê³¼ ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
- **ì ìš©**: ìœ ì‚¬í•œ ë¬¸ì œ í•´ê²° ì‹œ ì°¸ê³ 

### 2. ì½”ë“œ íŒ¨í„´
- **ë¬´ì—‡**: ì‚¬ìš©ëœ ì½”ë“œ íŒ¨í„´ í™•ì¸ í•„ìš”
- **ì™œ ì¤‘ìš”**: ì¼ê´€ëœ ì½”ë“œ ìŠ¤íƒ€ì¼ ìœ ì§€
- **ì ìš©**: ìƒˆ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ ì°¸ê³ 

### 3. í…ŒìŠ¤íŠ¸ ì „ëµ
- **ë¬´ì—‡**: í…ŒìŠ¤íŠ¸ ì¶”ê°€/ìˆ˜ì • ì—¬ë¶€ í™•ì¸ í•„ìš”
- **ì™œ ì¤‘ìš”**: íšŒê·€ ë°©ì§€
- **ì ìš©**: í–¥í›„ ìœ ì‚¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œ ì°¸ê³ 

---

## ğŸ”— ë ˆí¼ëŸ°ìŠ¤

### ê´€ë ¨ ë§í¬
1. [PR #${prNumber}](${pr.html_url}) - ì›ë³¸ PR
${relatedIssue ? `2. [Issue #${relatedIssue}](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${relatedIssue}) - ê´€ë ¨ ì´ìŠˆ` : ''}

### ì¶”ì²œ í•™ìŠµ ìë£Œ
> âš ï¸ ì´ ì„¹ì…˜ì€ ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.
> ê´€ë ¨ ê¸°ìˆ  ë¬¸ì„œë‚˜ íŠœí† ë¦¬ì–¼ ë§í¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.

---

## ğŸ·ï¸ íƒœê·¸

${tags.join(' ') || '#general'}

---

*ì´ ë³´ê³ ì„œëŠ” GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
*ìƒì„¸ í•™ìŠµ í¬ì¸íŠ¸ì™€ ë ˆí¼ëŸ°ìŠ¤ëŠ” ìˆ˜ë™ìœ¼ë¡œ ë³´ì™„í•´ì£¼ì„¸ìš”.*
`;

            // íŒŒì¼ ì´ë¦„
            const filename = `LessonLearn/${date}_PR${prNumber}_${slug}.md`;

            // íŒŒì¼ ìƒì„± (base64 ì¸ì½”ë”©)
            const content = Buffer.from(report).toString('base64');

            try {
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: filename,
                message: `docs: Add tech report for PR #${prNumber}`,
                content: content,
                branch: 'main'
              });

              console.log(`Created tech report: ${filename}`);

              // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ğŸ“š ê¸°ìˆ  ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ

ê¸°ìˆ  ë³´ê³ ì„œê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: [\`${filename}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/${filename})

### ë‹¤ìŒ ë‹¨ê³„
- [ ] í•™ìŠµ í¬ì¸íŠ¸ ìƒì„¸í™”
- [ ] ë ˆí¼ëŸ°ìŠ¤ ë§í¬ ì¶”ê°€
- [ ] íƒœê·¸ ë³´ì™„

---
*Technical Writer Agent (GitHub Actions)*`
              });

            } catch (error) {
              console.error('Failed to create tech report:', error);

              // ì‹¤íŒ¨ ì‹œ PRì— ì•Œë¦¼
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## âš ï¸ ê¸°ìˆ  ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨

ìë™ ê¸°ìˆ  ë³´ê³ ì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
ìˆ˜ë™ìœ¼ë¡œ LessonLearn í´ë”ì— ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì—ëŸ¬: ${error.message}`
              });
            }
