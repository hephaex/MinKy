name: Issue Triage

on:
  schedule:
    # 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
    - cron: '0 * * * *'
  issues:
    types: [opened]
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Add needs-triage label to new issues
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;

            // ìƒˆ ì´ìŠˆì— needs-triage ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['status:needs-triage']
            });

            console.log(`Added needs-triage label to issue #${issueNumber}`);

      - name: Analyze and label issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'status:needs-triage',
              per_page: 10
            });

            for (const issue of issues) {
              const title = issue.title.toLowerCase();
              const body = (issue.body || '').toLowerCase();
              const content = title + ' ' + body;

              const labelsToAdd = [];

              // ë¬¸ì œ ìœ í˜• ë¶„ë¥˜
              if (content.includes('ë²„ê·¸') || content.includes('ì˜¤ë¥˜') ||
                  content.includes('ì—ëŸ¬') || content.includes('ì•ˆë¨') ||
                  content.includes('bug') || content.includes('error')) {
                labelsToAdd.push('type:bug');
              } else if (content.includes('ê¸°ëŠ¥') || content.includes('ì¶”ê°€') ||
                         content.includes('feature') || content.includes('ìƒˆë¡œìš´')) {
                labelsToAdd.push('type:feature');
              } else if (content.includes('ê°œì„ ') || content.includes('ë¦¬íŒ©í† ë§') ||
                         content.includes('ì„±ëŠ¥') || content.includes('improve')) {
                labelsToAdd.push('type:enhancement');
              } else if (content.includes('ë¬¸ì„œ') || content.includes('readme') ||
                         content.includes('docs')) {
                labelsToAdd.push('type:docs');
              }

              // ìš°ì„ ìˆœìœ„ ë¶„ë¥˜
              if (content.includes('ê¸´ê¸‰') || content.includes('ì¥ì• ') ||
                  content.includes('critical') || content.includes('ì„œë¹„ìŠ¤')) {
                labelsToAdd.push('priority:critical');
              } else if (content.includes('ì¤‘ìš”') || content.includes('ë³´ì•ˆ') ||
                         content.includes('important') || content.includes('security')) {
                labelsToAdd.push('priority:high');
              } else {
                labelsToAdd.push('priority:medium');
              }

              // ì˜ì—­ ë¶„ë¥˜
              if (content.includes('backend') || content.includes('rust') ||
                  content.includes('api') || content.includes('ì„œë²„')) {
                labelsToAdd.push('area:backend');
              } else if (content.includes('frontend') || content.includes('react') ||
                         content.includes('ui') || content.includes('í™”ë©´')) {
                labelsToAdd.push('area:frontend');
              }

              // ë¼ë²¨ ì¶”ê°€
              if (labelsToAdd.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: labelsToAdd
                });
              }

              // needs-triage ì œê±°í•˜ê³  pm-reviewed ì¶”ê°€
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'status:needs-triage'
              }).catch(() => {});

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['status:pm-reviewed']
              });

              // PM ë¶„ì„ ì½”ë©˜íŠ¸ ì¶”ê°€
              const analysisComment = `## ğŸ¤– PM Issue Analysis

### ìš”ì•½
ì´ ì´ìŠˆê°€ ìë™ìœ¼ë¡œ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.

### ë¶„ë¥˜
- **Labels**: ${labelsToAdd.join(', ') || 'None detected'}
- **Status**: PM Reviewed

### ë‹¤ìŒ ë‹¨ê³„
1. ë‹´ë‹¹ì ì§€ì •ì´ í•„ìš”í•©ë‹ˆë‹¤
2. ìƒì„¸ ì‘ì—… ë¶„í•´ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

---
*ì´ ë¶„ì„ì€ GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: analysisComment
              });

              console.log(`Processed issue #${issue.number}: ${issue.title}`);
            }
